---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getAllEntries } from '@/utils/getAllEntries';
import { slugify } from '@/utils/slugify';
import { getPathBySlug } from '@/utils/getPathBySlug';
import BlogPost from '@/components/entries/BlogPost.astro';

export const prerender = true;

export async function getStaticPaths() {
  const allEntries = (await getAllEntries()).filter(Boolean);

  const tagSet = new Set<string>();

  for (const entry of allEntries) {
    if (!entry?.data) continue;

    const tags = entry.data.tags;
    if (!Array.isArray(tags)) continue;

    for (const rawTag of tags) {
      if (!rawTag) continue;

      const slug = slugify(String(rawTag).trim());
      if (!slug) continue;

      tagSet.add(slug);
    }
  }

  return Array.from(tagSet).map(tag => ({
    params: { tag },
  }));
}

// 当前参数
const tagParam = Astro.params.tag;

if (!tagParam) {
  throw new Error('[tag].astro rendered without tag param');
}

const tag = tagParam;
const tagSlug = slugify(tag);

// 所有文章
const allEntries = (await getAllEntries()).filter(
  (e): e is { data: any; slug: string } => Boolean(e && e.data)
);

// DEBUG（现在这里应该永远是 []）
console.log(
  'INVALID ENTRIES:',
  allEntries.filter(e => !e || !e.data)
);

const posts = allEntries
  .filter(entry =>
    Array.isArray(entry.data.tags) &&
    entry.data.tags.some(t => slugify(String(t)) === tagSlug)
  )
  .sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

const postsWithPaths = await Promise.all(
  posts.map(async (post) => {
    const href = await getPathBySlug(post.slug);
    return { ...post, href };
  })
);
---

<BaseLayout title={`Tag: ${tag}`}>
  <section class="container-wide">
    <div class="mt-32"></div>
    <div>
      <h1 class="text-4xl md:text-8xl/24 font-serif first-line:font-sans font-medium first-line:font-bold mb-8 uppercase tracking-tight">
        Tag
        <br>
        {tag} <sup class="align-super font-sans text-4xl" title={`共有 ${posts.length} 篇文章`}>{posts.length}</sup>
      </h1>
    </div>
    
    <div class="pt-12 grid gap-8 sm:grid-cols-3">
      {postsWithPaths.map(post => (
        <BlogPost
          title={post.data.title}
          href={post.href}
          date={post.data.date}
          description={post.data.description}
          categories={post.data.categories}
          photos={post.data.photos}
        />
      ))}
    </div>
    
  </section>
</BaseLayout>
