---
import { getCollection } from 'astro:content';
import { collections } from '@/content/config';
import { collectionsMeta } from '@/content/collections.config';
import { config } from '@/site.config';
import { getCategories } from '@/utils/getCategories';

import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogPost from '@/components/entries/BlogPost.astro';
import Pagination from '@/components/global/Pagination.astro';
import Categories from '@/components/entries/Categories.astro';

export const prerender = true;

export async function getStaticPaths() {
  const collectionNames = Object.keys(collections); // ✅ 移动到函数内部
  const paths = [];

  for (const name of collectionNames) {
    const allEntries = await getCollection(name);
    const visibleEntries = allEntries
      .filter((entry) => entry.data.draft !== true)
      .sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

    const perPage = config.content.postsPerPage || 10;
    const totalPages = Math.ceil(visibleEntries.length / perPage);

    for (let i = 1; i <= totalPages; i++) {
      paths.push({
        params: {
          collection: name,
          page: i.toString(),
        },
        props: {
          collection: name,
          page: i,
          totalPages,
          posts: visibleEntries.slice((i - 1) * perPage, i * perPage),
          counts: visibleEntries.length,
        },
      });
    }
  }

  return paths;
}

const { collection, page = 1, posts = [], totalPages = 1, counts } = Astro.props;

const desc = collectionsMeta[collection].description;
const collectionName = collectionsMeta[collection].title;
---
<BaseLayout title={collection}>
  <main class="max-w-7xl mx-auto px-8">
    <div class="mt-32"></div>
    <div>
      <h1 class="text-6xl font-bold mb-8 capitalize">{collection} <span class="text-base align-top">{counts}</span></h1>
    </div>
    <div class="mt-24 flex flex-row">
      <div class="w-1/4 pr-12 flex">
        <span class="bg-black inline-block text-center rounded-full w-4 h-4 mr-2 mt-1">
          <svg viewBox="0 0 20 20" width="16" xmlns="http://www.w3.org/2000/svg" class="fill-white">
            <path clip-rule="evenodd" d="M10 5C10.5523 5 11 5.44772 11 6V9L14 9C14.5523 9 15 9.44772 15 10C15 10.5523 14.5523 11 14 11H11V14C11 14.5523 10.5523 15 10 15C9.44771 15 9 14.5523 9 14V11H6C5.44772 11 5 10.5523 5 10C5 9.44771 5.44772 9 6 9L9 9V6C9 5.44772 9.44771 5 10 5Z" fill-rule="evenodd"/>
          </svg>
        </span>
        {collectionName}
      </div>
      <div class="w-1/2">
        <Categories collection={collection}></Categories>
      </div>
      <div class="w-1/4 pl-12">
        <p class="font-serif">{desc}</p>
      </div>
    </div>
    
    <div class="pt-12 grid gap-8 sm:grid-cols-2">
      {posts.map((post, index) => (
        <BlogPost
          title={post.data.title}
          href={`/${collection}/${post.slug}`}
          date={post.data.date}
          description={post.data.description}
          categories={post.data.categories}
          photos={post.data.photos}
        />
      ))}
    </div>
    <Pagination collection={collection} page={page} totalPages={totalPages} />
  </main>
</BaseLayout>