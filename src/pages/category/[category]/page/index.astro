---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogPost from '@/components/entries/BlogPost.astro';
import { slugify } from '@/utils/slugify';
import { config } from '@/site.config';

export const prerender = true;

const perPage = config.content.postsPerPage || 10;
const { category } = Astro.params;

// 假设集合是 blog
const collection = 'blog';
const allPosts = await getCollection(collection);

const filteredPosts = allPosts.filter(post =>
  post.data.categories?.some(cat => slugify(cat) === category)
);

filteredPosts.sort((a, b) => Date.parse(b.data.date) - Date.parse(a.data.date));

const pagedPosts = filteredPosts.slice(0, perPage);

const totalPages = Math.ceil(filteredPosts.length / perPage);

export async function getStaticPaths() {
  const posts = await getCollection(collection);
  const categories = [...new Set(posts.flatMap(p => p.data.categories ?? []))];
  return categories.map(cat => ({
    params: {
      category: slugify(cat),
    }
  }));
}
---

<BaseLayout title={`分类: ${category}`}>
  <h1>分类：{category} - 第 1 页</h1>

  <ul>
    {pagedPosts.map(post => (
      <BlogPost
        title={post.data.title}
        href={`/blog/${post.slug}`}
        date={post.data.date}
        description={post.data.description}
      />
    ))}
  </ul>

  {totalPages > 1 && (
    <nav class="pagination">
      <a href={`/category/${category}/page/2`}>下一页 →</a>
    </nav>
  )}
</BaseLayout>
